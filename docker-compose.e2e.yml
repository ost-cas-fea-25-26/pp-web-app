services:
  postgres:
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: pp-user
      POSTGRES_PASSWORD: pp-password
      POSTGRES_DB: pp-database
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pp-user -d pp-database"]
      interval: 5s
      timeout: 5s
      retries: 10

  playwright:
    image: mcr.microsoft.com/playwright:v1.56.1-jammy
    depends_on:
      postgres:
        condition: service_healthy

    working_dir: /app
    volumes:
      - .:/app

    environment:
      NEON_DATABASE_URL: postgresql://pp-user:pp-password@postgres:5432/pp-database
      VERCEL_URL: http://localhost:3000
      HOME: /root

      AUTH_CLIENT_ID: ${AUTH_CLIENT_ID}
      AUTH_SECRET: ${AUTH_SECRET}
      API_URL: http://localhost:1080

      PLAYWRIGHT_TEST_USER_1_EMAIL: ${PLAYWRIGHT_TEST_USER_1_EMAIL}
      PLAYWRIGHT_TEST_USER_1_PASSWORD: ${PLAYWRIGHT_TEST_USER_1_PASSWORD}

    command: >
      bash -lc "
        echo 'Installing Java (required for axe)...' &&
        apt-get update &&
        apt-get install -y openjdk-17-jre-headless &&
        java -version &&

        echo 'Installing dependencies...' &&
        npm ci --no-audit --no-fund &&

        echo 'Installing Playwright browsers...' &&
        npx playwright install --with-deps &&

        echo 'Running migrations...' &&
        npm run db:migrate &&

        echo 'Running Playwright (update snapshots)...' &&
        npx playwright test --update-snapshots
      "
